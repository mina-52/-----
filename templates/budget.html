<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>予算管理</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
:root {
    --primary: #6366f1;
    --secondary: #8b5cf6;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
}

body {
    font-family: 'Segoe UI', 'メイリオ', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px 0;
}

.card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    margin-bottom: 25px;
    background: white;
}

.card-header {
    background: linear-gradient(135deg, var(--success), #059669);
    color: white;
    border-radius: 20px 20px 0 0 !important;
    padding: 25px;
    font-weight: 600;
}

.page-title {
    color: white;
    text-align: center;
    margin-bottom: 40px;
    font-weight: 800;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
}

.btn-modern {
    border-radius: 12px;
    padding: 12px 28px;
    font-weight: 600;
    transition: all 0.3s;
    border: none;
}

.btn-success-modern {
    background: linear-gradient(135deg, var(--success), #059669);
    color: white;
}

.btn-primary-modern {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
}

.btn-danger-modern {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    color: white;
}

.form-control, .form-select {
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    padding: 12px 15px;
    transition: all 0.3s;
}

.form-control:focus, .form-select:focus {
    border-color: var(--success);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    outline: none;
}

.table-modern {
    background: white;
    border-radius: 12px;
    overflow: hidden;
}

.table-modern thead {
    background: linear-gradient(135deg, var(--success), #059669);
    color: white;
}

.progress-bar-custom {
    height: 25px;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
</head>
<body>
<div class="container">
    <h1 class="page-title"><i class="bi bi-piggy-bank"></i> 予算管理</h1>
    
    <div class="text-center mb-4">
        <a href="/" class="btn btn-modern btn-primary-modern">
            <i class="bi bi-arrow-left"></i> トップに戻る
        </a>
    </div>

    <!-- 予算追加フォーム -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-plus-circle"></i> 予算の追加</h5>
        </div>
        <div class="card-body">
            <form method="POST">
                <input type="hidden" name="action" value="add">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">区分</label>
                        <select name="category" class="form-select" required>
                            <option value="収入">収入</option>
                            <option value="支出">支出</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">サブカテゴリ</label>
                        <input type="text" name="subcategory" class="form-control" placeholder="任意">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">予算額</label>
                        <input type="number" name="amount" class="form-control" required min="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">年月</label>
                        <input type="month" name="month" class="form-control" value="{{ current_month }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-modern btn-success-modern w-100">
                            <i class="bi bi-check"></i> 追加
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 予算と実績の比較 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 予算と実績の比較</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-modern table-hover">
                    <thead>
                        <tr>
                            <th>区分</th>
                            <th>サブカテゴリ</th>
                            <th>予算</th>
                            <th>実績</th>
                            <th>残額</th>
                            <th>達成率</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp in budget_comparison %}
                        <tr>
                            <td><strong>{{ comp[1] }}</strong></td>
                            <td>{{ comp[2] or '-' }}</td>
                            <td class="text-primary"><strong>{{ "{:,}".format(comp[3]|int) }}</strong> 円</td>
                            <td class="text-danger"><strong>{{ "{:,}".format(comp[4]|int) }}</strong> 円</td>
                            <td class="{% if (comp[3]|int) - (comp[4]|int) >= 0 %}text-success{% else %}text-danger{% endif %}">
                                <strong>{{ "{:,}".format((comp[3]|int) - (comp[4]|int)) }}</strong> 円
                            </td>
                            <td>
                                {% set percentage = ((comp[4]|int) / (comp[3]|int) * 100) if (comp[3]|int) > 0 else 0 %}
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar {% if percentage > 100 %}bg-danger{% elif percentage > 80 %}bg-warning{% else %}bg-success{% endif %} progress-bar-custom" 
                                         role="progressbar" 
                                         style="width: {{ min(percentage, 100) }}%">
                                        {{ "%.1f"|format(percentage) }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not budget_comparison %}
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                                予算データがありません
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 予算一覧 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> 予算一覧</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-modern table-hover">
                    <thead>
                        <tr>
                            <th>区分</th>
                            <th>サブカテゴリ</th>
                            <th>予算額</th>
                            <th>年月</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for budget in budgets %}
                        <tr>
                            <td><strong>{{ budget[1] }}</strong></td>
                            <td>{{ budget[2] or '-' }}</td>
                            <td class="text-primary"><strong>{{ "{:,}".format(budget[3]|int) }}</strong> 円</td>
                            <td>{{ budget[4] or '-' }}</td>
                            <td>
                                <form method="POST" style="display:inline;" onsubmit="return confirm('削除しますか？');">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="budget_id" value="{{ budget[0] }}">
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i> 削除
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not budgets %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                                予算データがありません
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

